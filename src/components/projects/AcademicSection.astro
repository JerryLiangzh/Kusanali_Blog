---
import type { ImageMetadata } from 'astro'
import { Image } from 'astro:assets'
import type { iconsType } from 'packages/pure/types'
import { cn } from 'packages/pure/utils'

interface Project {
  image?: string
  name: string
  description: string
  authors?: string[]  // 可选：作者列表
  journal?: string    // 可选：期刊/会议名称
  year?: string       // 可选：发表年份
  tags?: string[]     // 可选：标签（如 Preprint/Published）
  links: {
    href: string
  }[]
}

interface Props {
  class?: string
  projects: Project[]
}
const { class: className, projects, ...props } = Astro.props
const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/projects/*.{jpeg,jpg,png,gif,avif.webp,webp}'
)
const projectIconSet: Record<string, iconsType> = {
  github: 'github-circle',
  site: 'earth',
  doc: 'document',
  release: 'package'
}
---

<div class={className} {...props}>
  <!-- 关键改动：单列布局 + 增大间距；移除了line-clamp-1，允许换行，并调整字体大小 -->
  <div class='grid grid-cols-1 gap-y-4 sm:gap-y-6'>
    {
      projects.map((project) => {
        var imagePath = null
        if (project.image) {
          imagePath = '/src/assets/projects/' + project.image
          if (!images[imagePath])
            throw new Error(
              `"${imagePath}" does not exist in glob: "src/assets/projects/*.{jpeg,jpg,png,gif,avif,webp}"`
            )
        }

        return (
          <div class='relative overflow-hidden rounded-xl border p-4 sm:p-6 transition-colors hover:border-primary/50'>
            {imagePath && (
              <Image
                class='absolute end-0 top-0 z-0 m-0 h-full w-1/3 object-cover opacity-20'
                src={images[imagePath]()}
                alt={project.name}
                loading='lazy'
                style={{
                  maskImage:
                    'linear-gradient(to right, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 1) 100%)',
                  msMaskImage:
                    '-ms-linear-gradient(to right, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 1) 100%)',
                  WebkitMaskImage:
                    '-webkit-linear-gradient(to right, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 1) 100%)'
                }}
              />
            )}
            
            <div
              class={cn(
                'relative z-10 flex flex-col gap-y-3',
                imagePath && 'me-32'  // 为图片预留空间
              )}
            >
              <!-- 标题：完整显示，允许换行 -->
              <a
                class='text-lg font-semibold text-foreground no-underline transition-colors hover:text-primary leading-snug'
                href={project.links[0].href}
                target='_blank'
                rel="noopener noreferrer"
              >
                {project.name}
              </a>
              
              <!-- 元数据行：作者、期刊、年份 -->
              {(project.authors || project.journal || project.year) && (
                <div class='flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-muted-foreground'>
                  {project.authors && (
                    <span class='line-clamp-1'>
                      {project.authors.slice(0, 3).join(', ')}
                      {project.authors.length > 3 && ' et al.'}
                    </span>
                  )}
                  {project.journal && <span class='font-medium'>{project.journal}</span>}
                  {project.year && <span>{project.year}</span>}
                </div>
              )}
              
              <!-- 描述 -->
              <div class='leading-relaxed text-muted-foreground'>
                {project.description}
              </div>
              
              <!-- 标签（如 Preprint/Published） -->
              {project.tags && project.tags.length > 0 && (
                <div class='flex flex-wrap gap-2'>
                  {project.tags.map(tag => (
                    <span class='rounded-full bg-blue-100 text-blue-800 px-2 py-0.5 text-xs font-medium'>
                      {tag}
                    </span>
                  ))}
                </div>
              )}
              
            </div>
          </div>
        )
      })
    }
  </div>
</div>